{% extends "base.html" %}

{% block title %}Заявки - Система заявок{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0">
                <i class="bi bi-list-ul"></i> Заявки
            </h1>
            <a href="{{ url_for('create_ticket') }}" class="btn btn-primary">
                <i class="bi bi-plus"></i> Створити заявку
            </a>
        </div>
    </div>
</div>

<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <form method="GET" action="{{ url_for('tickets') }}" class="row g-3">
                    <input type="hidden" name="sort_by" value="{{ sort_by }}">
                    <input type="hidden" name="sort_order" value="{{ sort_order }}">
                    {% if is_admin %}
                    <div class="col-md-2">
                        <label class="form-label">Компанія</label>
                        <select name="company_id" class="form-select">
                            <option value="">Всі</option>
                            {% for company in companies %}
                            <option value="{{ company.id }}" {% if selected_company_id == company.id %}selected{% endif %}>
                                {{ company.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}
                    <div class="col-md-2">
                        <label class="form-label">Статус</label>
                        <select name="status" class="form-select">
                            <option value="">Всі</option>
                            {% for status in all_statuses %}
                            <option value="{{ status.code }}" {% if selected_status == status.code %}selected{% endif %}>
                                {{ status.name_ua }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Тип</label>
                        <select name="ticket_type" class="form-select">
                            <option value="">Всі</option>
                            <option value="REFILL" {% if selected_ticket_type == 'REFILL' %}selected{% endif %}>Заправка</option>
                            <option value="REPAIR" {% if selected_ticket_type == 'REPAIR' %}selected{% endif %}>Ремонт</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Період</label>
                        <select name="period" id="periodSelect" class="form-select">
                            <option value="">Весь період</option>
                            <option value="today" {% if selected_period == 'today' %}selected{% endif %}>Сьогодні</option>
                            <option value="yesterday" {% if selected_period == 'yesterday' %}selected{% endif %}>Вчора</option>
                            <option value="week" {% if selected_period == 'week' %}selected{% endif %}>Останні 7 днів</option>
                            <option value="month" {% if selected_period == 'month' %}selected{% endif %}>Останні 30 днів</option>
                            <option value="custom" {% if selected_period == 'custom' %}selected{% endif %}>Кастомний період</option>
                        </select>
                    </div>
                    <div class="col-md-2" id="dateFromGroup" style="display: {% if selected_period == 'custom' %}block{% else %}none{% endif %};">
                        <label class="form-label">Дата від</label>
                        <input type="date" name="date_from" id="dateFrom" class="form-control" value="{{ selected_date_from }}">
                    </div>
                    <div class="col-md-2" id="dateToGroup" style="display: {% if selected_period == 'custom' %}block{% else %}none{% endif %};">
                        <label class="form-label">Дата до</label>
                        <input type="date" name="date_to" id="dateTo" class="form-control" value="{{ selected_date_to }}">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-search"></i> Фільтрувати
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                {% if tickets %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>
                                    {% if sort_by == 'id' %}
                                        {% set next_order_id = 'asc' if sort_order == 'desc' else 'desc' %}
                                    {% else %}
                                        {% set next_order_id = 'desc' %}
                                    {% endif %}
                                    <a href="{{ url_for('tickets', sort_by='id', sort_order=next_order_id, company_id=selected_company_id, status=selected_status, ticket_type=selected_ticket_type, period=selected_period, date_from=selected_date_from, date_to=selected_date_to) }}" class="text-decoration-none text-reset">
                                        №
                                        {% if sort_by == 'id' %}
                                            {% if sort_order == 'asc' %}<i class="bi bi-arrow-up"></i>{% else %}<i class="bi bi-arrow-down"></i>{% endif %}
                                        {% endif %}
                                    </a>
                                </th>
                                <th>
                                    {% if sort_by == 'ticket_type' %}
                                        {% set next_order_type = 'asc' if sort_order == 'desc' else 'desc' %}
                                    {% else %}
                                        {% set next_order_type = 'desc' %}
                                    {% endif %}
                                    <a href="{{ url_for('tickets', sort_by='ticket_type', sort_order=next_order_type, company_id=selected_company_id, status=selected_status, ticket_type=selected_ticket_type, period=selected_period, date_from=selected_date_from, date_to=selected_date_to) }}" class="text-decoration-none text-dark">
                                        Тип
                                        {% if sort_by == 'ticket_type' %}
                                            {% if sort_order == 'asc' %}<i class="bi bi-arrow-up"></i>{% else %}<i class="bi bi-arrow-down"></i>{% endif %}
                                        {% endif %}
                                    </a>
                                </th>
                                <th>
                                    {% if sort_by == 'status' %}
                                        {% set next_order_status = 'asc' if sort_order == 'desc' else 'desc' %}
                                    {% else %}
                                        {% set next_order_status = 'desc' %}
                                    {% endif %}
                                    <a href="{{ url_for('tickets', sort_by='status', sort_order=next_order_status, company_id=selected_company_id, status=selected_status, ticket_type=selected_ticket_type, period=selected_period, date_from=selected_date_from, date_to=selected_date_to) }}" class="text-decoration-none text-dark">
                                        Статус
                                        {% if sort_by == 'status' %}
                                            {% if sort_order == 'asc' %}<i class="bi bi-arrow-up"></i>{% else %}<i class="bi bi-arrow-down"></i>{% endif %}
                                        {% endif %}
                                    </a>
                                </th>
                                <th>
                                    {% if sort_by == 'priority' %}
                                        {% set next_order_priority = 'asc' if sort_order == 'desc' else 'desc' %}
                                    {% else %}
                                        {% set next_order_priority = 'desc' %}
                                    {% endif %}
                                    <a href="{{ url_for('tickets', sort_by='priority', sort_order=next_order_priority, company_id=selected_company_id, status=selected_status, ticket_type=selected_ticket_type, period=selected_period, date_from=selected_date_from, date_to=selected_date_to) }}" class="text-decoration-none text-dark">
                                        Пріоритет
                                        {% if sort_by == 'priority' %}
                                            {% if sort_order == 'asc' %}<i class="bi bi-arrow-up"></i>{% else %}<i class="bi bi-arrow-down"></i>{% endif %}
                                        {% endif %}
                                    </a>
                                </th>
                                <th>Компанія</th>
                                <th>Користувач</th>
                                <th>
                                    {% if sort_by == 'created_at' %}
                                        {% set next_order_date = 'asc' if sort_order == 'desc' else 'desc' %}
                                    {% else %}
                                        {% set next_order_date = 'desc' %}
                                    {% endif %}
                                    <a href="{{ url_for('tickets', sort_by='created_at', sort_order=next_order_date, company_id=selected_company_id, status=selected_status, ticket_type=selected_ticket_type, period=selected_period, date_from=selected_date_from, date_to=selected_date_to) }}" class="text-decoration-none text-dark">
                                        Дата створення
                                        {% if sort_by == 'created_at' %}
                                            {% if sort_order == 'asc' %}<i class="bi bi-arrow-up"></i>{% else %}<i class="bi bi-arrow-down"></i>{% endif %}
                                        {% endif %}
                                    </a>
                                </th>
                                <th>Дії</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ticket in tickets %}
                            <tr {% if ticket.status == 'CLOSED' or ticket.status == 'CANCELLED' %}class="ticket-closed"{% elif ticket.chat_is_active %}class="table-info"{% endif %}>
                                <td>
                                    #{{ ticket.id }}
                                    {% if ticket.chat_is_active %}
                                    <a href="{{ url_for('ticket_chat', ticket_id=ticket.id) }}" class="text-decoration-none ms-2" title="Активний чат - натисніть для відкриття">
                                        <span class="badge bg-info text-dark">
                                            <i class="bi bi-chat-dots-fill"></i> Чат активний
                                        </span>
                                    </a>
                                    {% endif %}
                                </td>
                                <td>{{ ticket.ticket_type | ticket_type_ua }}</td>
                                <td>
                                    {% if ticket.status == 'CLOSED' or ticket.status == 'CANCELLED' %}
                                    <span class="badge bg-secondary text-muted">{{ ticket.status | status_ua }}</span>
                                    {% else %}
                                    <span class="badge {{ ticket.status | status_badge_color(ticket.ticket_type) }}">{{ ticket.status | status_ua }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if ticket.status == 'CLOSED' or ticket.status == 'CANCELLED' %}
                                    <span class="badge bg-secondary text-muted">{{ ticket.priority | priority_ua }}</span>
                                    {% else %}
                                    <span class="badge {{ ticket.priority | priority_badge_color }}">{{ ticket.priority | priority_ua }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ ticket.company_name or 'Невідомо' }}</td>
                                <td>
                                    {{ ticket.user_name or 'Невідомо' }}
                                    {% if ticket.user_is_vip %}
                                    <span class="badge bg-warning text-dark ms-1" title="VIP користувач - заявки з високим пріоритетом">⭐ VIP</span>
                                    {% endif %}
                                </td>
                                <td>{{ ticket.created_at[:10] if ticket.created_at else 'Невідомо' }}</td>
                                <td>
                                    <a href="{{ url_for('ticket_detail', ticket_id=ticket.id) }}" class="btn btn-sm btn-primary">
                                        <i class="bi bi-eye"></i> Переглянути
                                    </a>
                                    {% if ticket.chat_is_active %}
                                    <a href="{{ url_for('ticket_chat', ticket_id=ticket.id) }}" class="btn btn-sm btn-info ms-1" title="Відкрити чат">
                                        <i class="bi bi-chat-dots-fill"></i>
                                    </a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">Заявок не знайдено.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
.ticket-closed {
    opacity: 0.5;
    color: #6c757d !important;
}

.ticket-closed td {
    text-decoration: line-through;
    color: #6c757d !important;
}

.ticket-closed .badge {
    background-color: #6c757d !important;
    color: #ffffff !important;
}

.ticket-closed .btn {
    opacity: 0.6;
}

table thead th a {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    text-decoration: none;
}

/* Для світлої теми - темний текст */
[data-bs-theme="light"] table thead th a,
html[data-bs-theme="light"] table thead th a {
    color: #212529 !important;
}

/* Для темної теми - світлий колір як у шапці (navbar-dark) */
[data-bs-theme="dark"] table thead th a,
html[data-bs-theme="dark"] table thead th a,
body[data-bs-theme="dark"] table thead th a {
    color: #ffffff !important;
}

table thead th a:hover {
    color: #0d6efd !important;
    opacity: 0.8;
}

[data-bs-theme="dark"] table thead th a:hover,
html[data-bs-theme="dark"] table thead th a:hover,
body[data-bs-theme="dark"] table thead th a:hover {
    color: #6ea8fe !important;
}

table thead th a i {
    font-size: 0.8em;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const periodSelect = document.getElementById('periodSelect');
    const dateFromGroup = document.getElementById('dateFromGroup');
    const dateToGroup = document.getElementById('dateToGroup');
    const dateFrom = document.getElementById('dateFrom');
    const dateTo = document.getElementById('dateTo');
    
    periodSelect.addEventListener('change', function() {
        if (this.value === 'custom') {
            dateFromGroup.style.display = 'block';
            dateToGroup.style.display = 'block';
        } else {
            dateFromGroup.style.display = 'none';
            dateToGroup.style.display = 'none';
            // Очищаємо поля дат для швидких періодів (сервер обробляє їх автоматично)
            dateFrom.value = '';
            dateTo.value = '';
        }
    });
});
</script>
{% endblock %}

