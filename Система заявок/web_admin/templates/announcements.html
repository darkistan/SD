{% extends "base.html" %}
{% block title %}Оголошення - Система заявок{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-md-8">
        <h1><i class="bi bi-megaphone"></i> Управління оголошеннями</h1>
        <p class="text-muted">Створюйте та відправляйте оголошення користувачам прямо в Telegram</p>
    </div>
    <div class="col-md-4 text-end">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createAnnouncementModal">
            <i class="bi bi-plus-circle"></i> Створити оголошення
        </button>
    </div>
</div>

<!-- Список відправлених оголошень -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-list"></i> Історія відправлених оголошень ({{announcements|length}})</h5>
            </div>
            <div class="card-body">
                {% if announcements %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Зміст</th>
                                <th>Пріоритет</th>
                                <th>Автор</th>
                                <th>Час відправки</th>
                                <th>Отримувачів</th>
                                <th>Дії</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ann in announcements %}
                            <tr>
                                <td>{{ann['id']}}</td>
                                <td>{% if ann['content']|length > 100 %}{{ann['content'][:100]}}...{% else %}{{ann['content']}}{% endif %}</td>
                                <td>
                                    <span class="badge {% if ann['priority'] == 'urgent' %}bg-danger{% elif ann['priority'] == 'important' %}bg-warning{% else %}bg-secondary{% endif %}">
                                        {% if ann['priority'] == 'urgent' %}Термінове
                                        {% elif ann['priority'] == 'important' %}Важливе
                                        {% else %}Звичайне
                                        {% endif %}
                                    </span>
                                </td>
                                <td>@{{ann['author_username']}}</td>
                                <td>
                                    {% if ann['sent_at'] %}
                                        {% if ann['sent_at'] is string %}
                                            {{ann['sent_at']}}
                                        {% else %}
                                            {{ann['sent_at'].strftime('%d.%m.%Y %H:%M')}}
                                        {% endif %}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-info">{{ann['recipient_count']}}</span>
                                </td>
                                <td>
                                    <a href="{{url_for('announcement_recipients', ann_id=ann['id'])}}" class="btn btn-sm btn-primary">
                                        <i class="bi bi-people"></i> Отримувачі
                                    </a>
                                    <form method="POST" action="{{url_for('delete_announcement', ann_id=ann['id'])}}" style="display:inline;" onsubmit="return confirm('Видалити оголошення?');">
                                        <input type="hidden" name="csrf_token" value="{{csrf_token()}}"/>
                                        <button type="submit" class="btn btn-sm btn-danger">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">Оголошень немає.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal створення оголошення -->
<div class="modal fade" id="createAnnouncementModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-plus-circle"></i> Створити та відправити оголошення</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{url_for('create_announcement')}}">
                <input type="hidden" name="csrf_token" value="{{csrf_token()}}"/>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Зміст оголошення <span class="text-danger">*</span></label>
                        <textarea class="form-control" name="content" rows="8" required placeholder="Введіть текст оголошення..."></textarea>
                        <small class="text-muted">Підтримується HTML форматування</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Пріоритет</label>
                        <select class="form-select" name="priority">
                            <option value="normal">Звичайне</option>
                            <option value="important">Важливе</option>
                            <option value="urgent">Термінове</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Тип вибору отримувачів <span class="text-danger">*</span></label>
                        <div class="btn-group w-100" role="group" aria-label="Тип вибору отримувачів">
                            <input type="radio" class="btn-check" name="recipient_type" id="recipient_type_users" value="users" checked onchange="toggleRecipientType()">
                            <label class="btn btn-outline-primary" for="recipient_type_users">
                                <i class="bi bi-people"></i> Окремі користувачі
                            </label>
                            
                            <input type="radio" class="btn-check" name="recipient_type" id="recipient_type_companies" value="companies" onchange="toggleRecipientType()">
                            <label class="btn btn-outline-primary" for="recipient_type_companies">
                                <i class="bi bi-building"></i> По компаніях
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3" id="recipients_users_select">
                        <label class="form-label">Виберіть користувачів</label>
                        {% if users %}
                        <select class="form-select" name="recipient_ids" multiple size="10" id="recipient_ids">
                            {% for user in users %}
                            <option value="{{user['user_id']}}">
                                {% if user.get('full_name') %}
                                    {{user['full_name']}} (@{{user['username']}})
                                {% else %}
                                    @{{user['username']}}
                                {% endif %}
                            </option>
                            {% endfor %}
                        </select>
                        <small class="text-muted">Утримуйте Ctrl (Cmd на Mac) для вибору кількох користувачів</small>
                        {% else %}
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> Немає користувачів для вибору. Спочатку додайте користувачів на сторінці "Користувачі".
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3" id="recipients_companies_select" style="display: none;">
                        <label class="form-label">Виберіть компанії</label>
                        {% if companies %}
                        <select class="form-select" name="company_ids" multiple size="10" id="company_ids">
                            {% for company in companies %}
                            <option value="{{company['id']}}">
                                {{company['name']}}
                            </option>
                            {% endfor %}
                        </select>
                        <small class="text-muted">Утримуйте Ctrl (Cmd на Mac) для вибору кількох компаній. Оголошення буде відправлено всім користувачам вибраних компаній.</small>
                        {% else %}
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> Немає компаній для вибору.
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Скасувати</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-send"></i> Відправити
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function toggleRecipientType() {
    const recipientType = document.querySelector('input[name="recipient_type"]:checked').value;
    const usersSelect = document.getElementById('recipients_users_select');
    const companiesSelect = document.getElementById('recipients_companies_select');
    const recipientIds = document.getElementById('recipient_ids');
    const companyIds = document.getElementById('company_ids');
    
    if (recipientType === 'companies') {
        // По компаніях
        usersSelect.style.display = 'none';
        companiesSelect.style.display = 'block';
        if (recipientIds) {
            recipientIds.required = false;
            Array.from(recipientIds.options).forEach(option => option.selected = false);
        }
        if (companyIds) {
            companyIds.required = true;
        }
    } else {
        // Окремі користувачі
        usersSelect.style.display = 'block';
        companiesSelect.style.display = 'none';
        if (recipientIds) {
            recipientIds.required = true;
        }
        if (companyIds) {
            companyIds.required = false;
            Array.from(companyIds.options).forEach(option => option.selected = false);
        }
    }
}

// Перевірка при завантаженні сторінки
document.addEventListener('DOMContentLoaded', function() {
    toggleRecipientType();
    const recipientIds = document.getElementById('recipient_ids');
    if (recipientIds && recipientIds.options.length === 0) {
        console.warn('Список користувачів порожній');
    }
});
</script>
{% endblock %}

