{% extends "base.html" %}

{% block title %}Створити заявку - Система заявок{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="bi bi-plus-circle"></i> Створити заявку
        </h1>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <form method="POST" action="{{ url_for('create_ticket') }}" id="ticketForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    
                    {% if is_admin %}
                    <div class="mb-3">
                        <label class="form-label">Користувач <span class="text-danger">*</span></label>
                        <select name="user_id" class="form-select" required>
                            <option value="">-- Виберіть користувача --</option>
                            {% for user in users %}
                            <option value="{{ user.user_id }}">{{ user.full_name or user.username }} ({{ user.user_id }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Компанія <span class="text-danger">*</span></label>
                        <select name="company_id" id="companySelect" class="form-select" required>
                            <option value="">-- Виберіть компанію --</option>
                            {% for company in companies %}
                            <option value="{{ company.id }}" data-printer-service="{{ '1' if company.printer_service_enabled else '0' }}">{{ company.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}
                    
                    <div class="mb-3">
                        <label class="form-label">Тип заявки <span class="text-danger">*</span></label>
                        <select name="ticket_type" id="ticketType" class="form-select" required>
                            <option value="">-- Виберіть тип --</option>
                            {% if printer_service_enabled %}
                            <option value="REFILL">Заправка картриджів</option>
                            <option value="REPAIR">Ремонт принтера</option>
                            {% endif %}
                            <option value="INCIDENT">Інцидент</option>
                        </select>
                        {% if not printer_service_enabled %}
                        <small class="text-muted">Обслуговування принтерів вимкнено для вашої компанії. Доступна тільки заявка типу "Інцидент".</small>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3" id="printerSection">
                        <label class="form-label">Принтер <span class="text-danger">*</span></label>
                        <select name="printer_id" id="printerSelect" class="form-select">
                            <option value="">-- Виберіть принтер --</option>
                            {% for printer in printers %}
                            <option value="{{ printer.id }}">{{ printer.model }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div id="cartridgesSection" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label">Картриджі</label>
                            <div id="cartridgesList"></div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Коментар</label>
                        <textarea name="comment" class="form-control" rows="3" placeholder="Коментар до заявки (опціонально)"></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check"></i> Створити заявку
                    </button>
                    <a href="{{ url_for('tickets') }}" class="btn btn-secondary">
                        <i class="bi bi-x"></i> Скасувати
                    </a>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Оновлення доступних типів заявок при виборі компанії (для адмінів)
{% if is_admin %}
document.getElementById('companySelect')?.addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const printerServiceEnabled = selectedOption.dataset.printerService === '1';
    const ticketTypeSelect = document.getElementById('ticketType');
    
    // Очищаємо вибір типу заявки, якщо вибрано тип, який тепер недоступний
    if (ticketTypeSelect.value === 'REFILL' || ticketTypeSelect.value === 'REPAIR') {
        if (!printerServiceEnabled) {
            ticketTypeSelect.value = '';
        }
    }
    
    // Оновлюємо опції
    const options = ticketTypeSelect.querySelectorAll('option');
    options.forEach(option => {
        if (option.value === 'REFILL' || option.value === 'REPAIR') {
            if (printerServiceEnabled) {
                option.style.display = '';
            } else {
                option.style.display = 'none';
            }
        }
    });
    
    // Оновлюємо повідомлення
    let messageElement = ticketTypeSelect.parentElement.querySelector('small.text-muted');
    if (!printerServiceEnabled) {
        if (!messageElement) {
            messageElement = document.createElement('small');
            messageElement.className = 'text-muted';
            ticketTypeSelect.parentElement.appendChild(messageElement);
        }
        messageElement.textContent = 'Обслуговування принтерів вимкнено для вибраної компанії. Доступна тільки заявка типу "Інцидент".';
    } else if (messageElement) {
        messageElement.remove();
    }
});
{% endif %}

// Обробка зміни типу заявки
document.getElementById('ticketType').addEventListener('change', function() {
    const ticketType = this.value;
    const printerSection = document.getElementById('printerSection');
    const printerSelect = document.getElementById('printerSelect');
    const cartridgesSection = document.getElementById('cartridgesSection');
    
    if (ticketType === 'INCIDENT') {
        // Для інцидентів принтер не обов'язковий
        printerSection.style.display = 'none';
        printerSelect.removeAttribute('required');
        cartridgesSection.style.display = 'none';
    } else {
        // Для інших типів принтер обов'язковий
        printerSection.style.display = 'block';
        printerSelect.setAttribute('required', 'required');
        if (ticketType === 'REFILL' && printerSelect.value) {
            // Якщо принтер вже вибрано, завантажуємо картриджі
            printerSelect.dispatchEvent(new Event('change'));
        } else {
            cartridgesSection.style.display = 'none';
        }
    }
});

document.getElementById('printerSelect').addEventListener('change', function() {
    const printerId = this.value;
    const ticketType = document.getElementById('ticketType').value;
    
    if (printerId && ticketType === 'REFILL') {
        // Завантажуємо сумісні картриджі
        fetch(`/api/compatible_cartridges/${printerId}`)
            .then(response => response.json())
            .then(data => {
                const list = document.getElementById('cartridgesList');
                list.innerHTML = '';
                
                if (data.cartridges && data.cartridges.length > 0) {
                    data.cartridges.forEach(cartridge => {
                        const div = document.createElement('div');
                        div.className = 'mb-2';
                        div.innerHTML = `
                            <div class="input-group">
                                <div class="input-group-text">
                                    <input type="checkbox" name="cartridge_ids[]" value="${cartridge.cartridge_type_id}" onchange="toggleQuantity(this, ${cartridge.cartridge_type_id})">
                                </div>
                                <input type="text" class="form-control" value="${cartridge.cartridge_name}" readonly>
                                <input type="number" name="quantities[]" class="form-control" placeholder="Кількість" min="1" id="qty_${cartridge.cartridge_type_id}" disabled>
                            </div>
                        `;
                        list.appendChild(div);
                    });
                    document.getElementById('cartridgesSection').style.display = 'block';
                } else {
                    document.getElementById('cartridgesSection').style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Помилка завантаження картриджів:', error);
            });
    } else {
        document.getElementById('cartridgesSection').style.display = 'none';
    }
});

document.getElementById('ticketType').addEventListener('change', function() {
    if (this.value === 'REPAIR') {
        document.getElementById('cartridgesSection').style.display = 'none';
    } else {
        const printerId = document.getElementById('printerSelect').value;
        if (printerId) {
            document.getElementById('printerSelect').dispatchEvent(new Event('change'));
        }
    }
});

function toggleQuantity(checkbox, cartridgeId) {
    const qtyInput = document.getElementById('qty_' + cartridgeId);
    if (checkbox.checked) {
        qtyInput.disabled = false;
        qtyInput.value = 1;
        qtyInput.required = true;
    } else {
        qtyInput.disabled = true;
        qtyInput.value = '';
        qtyInput.required = false;
    }
    }
</script>
{% endblock %}

